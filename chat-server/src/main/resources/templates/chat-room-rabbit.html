<!DOCTYPE html>
<meta charset="UTF-8">
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat Room</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<span>Welcome to Free Chat</span>
<ul id="message-list">
    <li th:each="messageObject : ${messageObjects}"
        th:text="'[' + ${#temporals.format(messageObject.timestamp, 'HH:mm')} + '] ' + ${messageObject.writer} + ': ' + ${messageObject.message}"></li>
</ul>
<form id="message-form">
    <label for="writer-input">ID : </label>
    <input type="text" id="writer-input" placeholder="Type your name..." th:value="${userId}" readonly/>
    <label for="message-input">Message : </label>
    <input type="text" id="message-input" placeholder="Type your message..." />
    <button type="submit">Send</button>
</form>

<script th:inline="javascript">
    /*<![CDATA[*/
    const chatRoomId = [[${chatRoomId}]]; // thymeleaf 변수
    const userId = [[${userId}]]; // thymeleaf 변수
    /*]]>*/

    const messageList = document.getElementById("message-list");
    const messageForm = document.getElementById("message-form");
    const messageInput = document.getElementById("message-input");

    let stompClient = null;

    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe(`/topic/chatRoom/${chatRoomId}`, function (message) {
                showMessage(JSON.parse(message.body));
            });
        });
    }

    connect();

    messageForm.addEventListener("submit", (event) => {
        event.preventDefault();

        const messageVal = messageInput.value.trim();
        if (!messageVal) {
            return;
        }

        const chatMessage = {
            writer: "",
            timestamp: null,
            chatRoomId: chatRoomId,
            message: messageVal,
            userId: userId
        };

        if (stompClient && stompClient.connected) {
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
        }
        messageInput.value = "";
    });

    function showMessage(message) {
        const listItem = document.createElement("li");
        let writer = message.writer && message.writer.length > 0 ? message.writer : "관리자";
        const timestamp = new Date(message.timestamp);
        const formattedTime = timestamp.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
        listItem.textContent = "[" + formattedTime + "] " + writer + ": " + message.message;
        messageList.appendChild(listItem);
    }
</script>
</body>
</html>